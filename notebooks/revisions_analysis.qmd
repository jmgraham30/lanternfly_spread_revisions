---
title: "Possible Analyses for Revisions"
format: 
  html:
    code-fold: true
bibliography: revisions_analysis.bib
---

```{r}
#| include: false
#| message: false
#| warning: false

library(tidyverse)
library(mgcv)
library(gratia)
library(broom.mixed)
library(kableExtra)
library(DHARMa)

theme_set(theme_minimal(base_size = 12))

data_folder <- "../data"
data_files <- paste0(data_folder,c("/data_1.csv","/data_2_temporal.csv","/data_to_map.csv","/data_to_map_21.csv"))

data_1 <- read_csv(data_files[1])
data_2_temporal <- read_csv(data_files[2])
data_to_map <- read_csv(data_files[3])
data_to_map_21 <- read_csv(data_files[4])

data_1 <- data_1 %>%
  mutate(pop_log = log10(pop),
         infested = i21,
         is_presence = ifelse(is_presence == 0, "No","Yes"))

data_2_temporal <- data_2_temporal %>%
  mutate(pop_log = log10(pop),
         year_zero = year - min(year),
         is_presence = ifelse(is_presence == 0, "No","Yes"))

data_to_map_166 <- data_to_map %>%
  filter(fips %in% data_2_temporal$fips)

data_14_21 <- data_2_temporal %>%
  select(-latitude,-longitude,-region,-sid,-e_dist)
```


## Overview

Using data collected on infestation by the spotted laternfly across 166 counties in the Mid-Atlantic region of the United States, we are interested to know about factors that likely contribute to spread of the organism. Here, we focus on factors related to human activity and that can be targeted for control or mitigation measures. The factors we focus on are:

* The number of businesses designated as garden centers in a county.

* The number of two-digit interstate highways that transect a county.

Further, we also examine the influence of the county population as previous work has established this as an important contributor to lanternfly spread. 

A reasonable question: does the data provide evidence that the transportation of materials sold at garden centers over interstate highways contribute to the spread of the spotted laternfly? 

## The Data

@tbl-data displays the first few rows of the data collected for the 166 county Mid-Atlantic region.

```{r}
#| label: tbl-data
#| tbl-cap: Data collected for the 166 county Mid-Atlantic region.
#| echo: false


data_14_21 %>%
  select(infested,year,county,state,nis,gc,pop) %>%
  head() %>%
  kable()
```


For analysis, we add to this data the boundaries for all included counties.   

```{r}
#| include: false

data_to_map_166 <- data_to_map %>%
  filter(fips %in% data_14_21$fips) %>%
  select(fips,long,lat,group)

dftm <- data_14_21 %>%
  right_join(.,data_to_map_166,by="fips",
             relationship = "many-to-many")

```

@fig-figure-1 displays the 2021 infestation status for the 166 Mid-Atlantic region counties in 2021:

```{r}
#| echo: false
#| label: fig-figure-1
#| fig-cap: Counties in the defined Mid-Atlantic regions that were designated as infested by the spotted laternfly in 2021. 

dftm %>%
  filter(year == "2021") %>%
  ggplot() +
  geom_polygon(mapping = aes(long, lat, group=group,fill=factor(infested)),color="black",
               linewidth=0.2)  +
  scale_fill_discrete(name="Infested",type=c("white","lightgreen")) + 
  labs(x="",y="",title = "2021 Infestations")
```


## Initial Exploratoration of the Data

@tbl-infestations displays the number of counties per year in the defined Mid-Atlantic region of 166 that were listed as infected.


```{r}
#| echo: false
#| label: tbl-infestations
#| tbl-cap: The number of counties per year in the defined Mid-Atlantic region of 166 that were listed as infected.

data_14_21 %>%
  group_by(year) %>%
  summarise(number_infested = sum(infested)) %>%
  rename(Year = year, `Number Infested` = number_infested) %>%
  kable()
```



```{r}
#| echo: false
#| include: false
#| label: fig-figure-2
#| fig-cap: Spotted laternfly infested counties for 2021 together with the numper of national parks in the county.

dftm %>%
  filter(year == "2021") %>%
  ggplot() +
  geom_polygon(mapping = aes(long, lat, group=group,fill=factor(infested)),color="black",
               linewidth=0.2)  +
  scale_fill_discrete(name="Infested",type=c("white","lightgreen")) + 
  geom_point(aes(longitude_num,latitude_num,color=nps),size=2) + 
  scale_color_continuous(low = "white", 
                        high = "darkblue",
                        limits = c(0,5)) + 
  labs(x="",y="",title = "2021 Infestations per NPS")
```


@fig-figure-3 shows the 166 counties in the defined Mid-Atlantic region together with their 2021 infestation status and the number of two-digit interstate highways that transect the county.

```{r}
#| echo: false
#| label: fig-figure-3
#| fig-cap: Spotted laternfly infested counties for 2021 together with the number of two-digit interstate highways transecting the counties.

dftm %>%
  filter(year == "2021") %>%
  ggplot() +
  geom_polygon(mapping = aes(long, lat, group=group,fill=factor(infested)),color="black",
               linewidth=0.2)  +
  scale_fill_discrete(name="Infested",type=c("white","lightgreen")) + 
  geom_point(aes(longitude_num,latitude_num,color=nis),size=2) + 
  scale_color_continuous(low = "white", 
                         high = "darkblue",
                         limits = c(0,3)) + 
  labs(x="",y="",title = "2021 Infestations per NIS")
```


@fig-figure-4 shows the 166 counties in the defined Mid-Atlantic region together with their 2021 infestation status and the number of garden centers in the county.

```{r}
#| echo: false
#| label: fig-figure-4
#| fig-cap: Spotted laternfly infested counties for 2021 together with the number of garden centers in the counties.

dftm %>%
  filter(year == "2021") %>%
  ggplot() +
  geom_polygon(mapping = aes(long, lat, group=group,fill=factor(infested)),color="black",
               linewidth=0.2)  +
  scale_fill_discrete(name="Infested",type=c("white","lightgreen")) + 
  geom_point(aes(longitude_num,latitude_num,color=gc),size=2) + 
  scale_color_continuous(low = "white", 
                         high = "darkblue",
                         limits = c(0,41)) + 
  labs(x="",y="",title = "2021 Infestations per GC")
```

@fig-figure-5 shows the 166 counties in the defined Mid-Atlantic region together with their 2021 infestation status and the county population on the log scale as estimated in 2019.

```{r}
#| echo: false
#| label: fig-figure-5
#| fig-cap: Spotted laternfly infested counties for 2021 together with the 2019 estimated population (log scale) for the counties.

dftm %>%
  filter(year == "2021") %>%
  ggplot() +
  geom_polygon(mapping = aes(long, lat, group=group,fill=factor(infested)),color="black",
               linewidth=0.2)  +
  scale_fill_discrete(name="Infested",type=c("white","lightgreen")) + 
  geom_point(aes(longitude_num,latitude_num,color=pop_log),size=2) + 
  scale_color_continuous(low = "white", 
                         high = "darkblue",
                         limits = c(3,7)) + 
  labs(x="",y="",title = "2021 Infestations per Pop (log)")
```


@fig-figure-6 shows the 166 counties in the defined Mid-Atlantic region together with the presence/absence of two-digit interstate highways and the number of garden center per county.


```{r}
#| echo: false
#| label: fig-figure-6
#| fig-cap: Spotted laternfly infested counties for 2021 together with the presence/absence of two-digit interstate highways and the number of garden center per county.

dftm %>%
  filter(year == "2021") %>%
  ggplot() +
  geom_polygon(mapping = aes(long, lat, group=group,fill=is_presence),color="black",
               linewidth=0.2)  +
  scale_fill_discrete(name="IS Presence",type=c("white","yellow")) + 
  geom_point(aes(longitude_num,latitude_num,color=gc),size=2) + 
  scale_color_continuous(low = "white", 
                         high = "darkblue",
                         limits = c(3,7)) + 
  labs(x="",y="",title = "Interstate Presence and Number of Garden Centers")

```

## Statistical Analysis


For a statistical test of our hypothesis, we have use R version 4.3.1 and package `mgcv` to fit a generalized additive model [@rcore; @wood2003; @wood2017generalized]. Specifically, we model the log odds of county infestation in 2021 with tensor product smoothing for longitude and latitude to control for spatial autocorrelation with linear predictors: presence/absence of two-digit interstate highway, number of garden centers, 2019 county population, and an interaction term for presence/absence of two-digit interstate highway and number of garden centers. To deal with issues of convergence and variables of different scale, we log transformed the population and centered and scaled the number of garden centers. We used the packages `DHARMa` and `gratia` for diagnostics of model assumptions  [@dharma2022 ; @gratia2023].

```{r}
#| code-fold: false

mod_form_21 <- infested ~ is_presence + std_gc + is_presence:std_gc + pop_log + 
   te(longitude,latitude)

gam_mod_21 <- gam(mod_form_21,data=data_1,
                      family = binomial(),
                      method = "REML")
```


```{r}
#| include: false

# model diagnostics

# DHARMa residuals
full_res <- simulateResiduals(gam_mod_21)

plot(full_res) # residuals look good

appraise(gam_mod_21) # residuals look good

acf(residuals(gam_mod_21)) # no temporal autocorrelation

testSpatialAutocorrelation(full_res,x=data_1$longitude,y=data_1$latitude) # spatial autocorrelation
```


@tbl-mod-summ summarizes the estimated coefficients for the linear predictors in the generalized additive model. 

```{r}
#| echo: false
#| label: tbl-mod-summ
#| tbl-cap: Summary table for estimates for linear terms in generalized additive model. 

gam_mod_21_summ <- summary(gam_mod_21)

results_df <- tibble(Coefficient = c("Intercept","IS Presence - Yes","Garden Centers","Pop (log)","IS Presence - Yes : Garden Centers"),
                     Estimate = gam_mod_21_summ$p.coeff,
                     SE = gam_mod_21_summ$se[1:5],
                     `p-value` = gam_mod_21_summ$p.pv)

results_df %>%
  kable()

```













```{r}
#| include: false

mod_form_14_21 <- infested ~ is_presence + std_gc + is_presence:std_gc +
  s(year_zero,k=8) + te(longitude_num,latitude_num)

gam_mod_14_21 <- gam(mod_form_14_21,data=data_2_temporal,
                      family = binomial(),
                      method = "REML")
```



```{r}
#| include: false

# model diagnostics

# DHARMa residuals
full_res <- simulateResiduals(gam_mod_14_21)

plot(full_res) # residuals look good

appraise(gam_mod_14_21) # residuals look good

acf(residuals(gam_mod_14_21)) # no temporal autocorrelation

#testSpatialAutocorrelation(full_res,x=data_1$longitude,y=data_1$latitude) # spatial autocorrelation
```


## References

::: {#refs}
:::


:::{.callout-tip collapse="true"}
## Expand for Session Info
```{r}
#| echo: false


library(sessioninfo)
# save the session info as an object
pkg_sesh <- session_info(pkgs = "attached")

# get the quarto version
quarto_version <- system("quarto --version", intern = TRUE)

# inject the quarto info
pkg_sesh$platform$quarto <- paste(
  system("quarto --version", intern = TRUE), 
  "@", 
  quarto::quarto_path()
  )

# print it out
pkg_sesh
```

:::
